<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台北市國小打鐘器｜School Bell</title>
  <meta name="description" content="一個可部署在 GitHub Pages 的學校打鐘網頁，時間到自動響鈴並顯示倒數與下一次打鐘。" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #7e8aa0;
      --text: #e8eefc;
      --accent: #79ffe1;
      --accent-2: #4cc9f0;
      --danger: #ff6b6b;
      --ok: #00d09c;
      --ring: #ffd166;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      font-synthesis-weight: none;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    html,body{height:100%;}
    body{
      margin:0; padding:24px; background: radial-gradient(1200px 600px at 20% -10%, #15213a, var(--bg));
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', Helvetica, Arial, 'Apple Color Emoji','Segoe UI Emoji';
      display:grid; place-items: center;
    }
    .app{width:min(980px, 100%); display:grid; gap:18px;}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px; box-shadow: var(--shadow)}
    h1{margin:0 0 6px; font-weight:800; letter-spacing:.3px}
    h2{margin:0 0 10px; font-size:18px; color:var(--accent)}
    .clock{font-variant-numeric: tabular-nums; font-size:52px; font-weight:800; letter-spacing:1px}
    .sub{color:var(--muted); font-size:14px}
    .row{display:flex; gap:10px; align-items:center}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:#1a2540; color:var(--text); border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(180deg, #1f2f54, #1a2540); border-color:#2e3a5a}
    .pill{display:inline-flex; align-items:center; gap:8px; background:#17223b; border:1px solid rgba(255,255,255,.08); color:var(--muted); padding:8px 12px; border-radius:999px}
    .ok{color:var(--ok)} .danger{color:var(--danger)} .ring{color:var(--ring)}
    .list{display:grid; gap:8px; margin-top:8px}
    .item{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:12px; background:#121a2b; border:1px solid rgba(255,255,255,.06)}
    .item .time{font-weight:800; letter-spacing:.5px}
    .item .label{color:var(--muted); font-size:12px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; background:#0d1424; border:1px solid rgba(255,255,255,.1); padding:2px 6px; border-radius:6px}
    textarea{width:100%; min-height:220px; resize:vertical; border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,.12); background:#0d1424; color:var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .footer{color:var(--muted); font-size:12px; text-align:center; margin-top:8px}
    .countdown{font-variant-numeric: tabular-nums; font-size:28px; font-weight:800}
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <div class="row" style="justify-content: space-between; align-items: flex-end;">
        <div>
          <h1>學校打鐘器 <span class="pill"><span id="tz"></span></span></h1>
          <div class="sub">部署在 GitHub Pages 的純前端打鐘工具。請先點「啟用鈴聲」以繞過瀏覽器的自動播放限制。</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn primary" id="enable">🔔 啟用鈴聲</button>
          <button class="btn" id="test">試聽</button>
          <button class="btn" id="notify">允許通知</button>
        </div>
      </div>
      <div class="row" style="justify-content: space-between; margin-top:10px">
        <div class="clock" id="clock">--:--:--</div>
        <div style="text-align:right">
          <div class="sub">下一次打鐘</div>
          <div id="nextTime" class="countdown">--:--（--:--）</div>
          <div id="nextLabel" class="sub"></div>
        </div>
      </div>
    </section>

    <section class="grid">
      <section class="card">
        <h2>今天時段</h2>
        <div id="todayList" class="list"></div>
      </section>

      <section class="card">
        <h2>設定</h2>
        <div class="sub" style="margin-bottom:8px">編輯下方 JSON（以 24 小時制 HH:MM，支援可選 label）。支援依星期設定：0=週日…6=週六。</div>
        <textarea id="scheduleEditor" spellcheck="false"></textarea>
        <div class="row" style="justify-content:flex-end; margin-top:8px">
          <button class="btn" id="reset">還原預設</button>
          <button class="btn primary" id="save">儲存設定</button>
        </div>
      </section>
    </section>

    <section class="card">
      <h2>使用說明</h2>
      <ol>
        <li>點擊 <span class="kbd">🔔 啟用鈴聲</span> 以啟用音訊播放權限。</li>
        <li>如需桌面提醒，點擊 <span class="kbd">允許通知</span> 並在瀏覽器允許通知權限。</li>
        <li>保持頁面開啟即可自動打鐘。</li>
      </ol>
      <div class="footer">Made for Taipei time; auto-detects your local timezone.</div>
    </section>
  </main>

  <script>
    // ========= 預設時程（可依實際學校調整） =========
    const DEFAULT_SCHEDULE = {
      // 週一至週五
      1: [
        { t: "08:00", label: "晨光/導師時間" },
        { t: "08:30", label: "第1節" },
        { t: "09:20", label: "下課" },
        { t: "09:30", label: "第2節" },
        { t: "10:10", label: "下課" },
        { t: "10:20", label: "第3節" },
        { t: "11:00", label: "下課" },
        { t: "11:10", label: "第4節" },
        { t: "11:50", label: "午餐" },
        { t: "12:40", label: "午休" },
        { t: "13:15", label: "第5節" },
        { t: "13:55", label: "下課" },
        { t: "14:00", label: "第6節" },
        { t: "14:40", label: "下課" },
        { t: "14:50", label: "第7/8節" },
        { t: "15:30", label: "打掃" },
        { t: "16:00", label: "放學" }
      ],
      2: null, 3: null, 4: null, 5: null,
      // 週六週日通常不上課
      0: [], 6: []
    };
    // 將週二至週五複製週一（若為 null）
    for (const d of [2,3,4,5]) if (!DEFAULT_SCHEDULE[d]) DEFAULT_SCHEDULE[d] = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE[1]));

    // ========= 狀態 =========
    let audioCtx = null;
    let lastRungKey = null; // e.g., "2025-08-27 08:30"

    // ========= 工具 =========
    const $ = (id) => document.getElementById(id);
    const pad = (n) => n.toString().padStart(2,'0');
    const fmt = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    const todayKey = (d=new Date()) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    function parseHHMM(hhmm){
      const [hh, mm] = hhmm.split(":").map(Number); return {hh, mm};
    }

    function loadSchedule(){
      const raw = localStorage.getItem('bell.schedule');
      if (raw){
        try{ return JSON.parse(raw); }catch(e){ console.warn('Invalid saved schedule, fallback to default'); }
      }
      return DEFAULT_SCHEDULE;
    }

    function saveSchedule(obj){
      localStorage.setItem('bell.schedule', JSON.stringify(obj, null, 2));
    }

    function getTodaySlots(){
      const now = new Date();
      const dow = now.getDay(); // 0 Sun .. 6 Sat
      const schedule = loadSchedule();
      return schedule[dow] || [];
    }

    function nextBell(from = new Date()){
      const now = from;
      const schedule = loadSchedule();
      for (let add=0; add<=7; add++){
        const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()+add, 0, 0, 0, 0);
        const dow = d.getDay();
        const slots = schedule[dow] || [];
        for (const s of slots){
          const {hh, mm} = parseHHMM(s.t);
          const when = new Date(d.getFullYear(), d.getMonth(), d.getDate(), hh, mm, 0, 0);
          const key = `${when.toISOString().slice(0,10)} ${pad(hh)}:${pad(mm)}`;
          if (when > now && key !== lastRungKey){
            return { when, label: s.label || '', key };
          }
        }
      }
      return null;
    }

    function renderToday(){
      const list = $('todayList');
      const slots = getTodaySlots();
      if (!slots.length){ list.innerHTML = '<div class="sub">今日無打鐘。</div>'; return; }
      list.innerHTML = slots.map(s => `
        <div class="item">
          <div class="time">${s.t}</div>
          <div class="label">${s.label || ''}</div>
        </div>
      `).join('');
    }

    function renderEditor(){
      const ed = $('scheduleEditor');
      const obj = loadSchedule();
      ed.value = JSON.stringify(obj, null, 2);
    }

    function updateNext(){
      const n = nextBell();
      const el = $('nextTime');
      const lbl = $('nextLabel');
      if (!n){ el.textContent = '—'; lbl.textContent=''; return; }
      const now = new Date();
      const secs = Math.max(0, Math.floor((n.when - now)/1000));
      const hh = Math.floor(secs/3600), mm = Math.floor((secs%3600)/60), ss = secs%60;
      el.textContent = `${pad(n.when.getHours())}:${pad(n.when.getMinutes())}（${pad(hh)}:${pad(mm)}:${pad(ss)}）`;
      lbl.textContent = n.label || '';
    }

    // ========= 鈴聲（無需音檔，WebAudio 產生） =========
    function ensureAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

    function ringBellPattern(){
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      // 三聲提示：高-低-高，類鐘聲
      const pattern = [
        { f: 1100, dur: 0.25 },
        { gap: 0.08 },
        { f: 800, dur: 0.25 },
        { gap: 0.08 },
        { f: 1100, dur: 0.35 },
      ];
      let t = now;
      for (const p of pattern){
        if (p.gap){ t += p.gap; continue; }
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = p.f;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.7, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + p.dur);
        o.connect(g).connect(ctx.destination);
        o.start(t); o.stop(t + p.dur + 0.02);
        t += p.dur;
      }
    }

    async function notify(title, body){
      try{
        if (Notification.permission === 'granted'){
          new Notification(title, { body });
        }
      }catch(e){ /* ignore */ }
    }

    function maybeRing(){
      const sched = loadSchedule();
      const now = new Date();
      const dow = now.getDay();
      const slots = sched[dow] || [];
      for (const s of slots){
        const {hh, mm} = parseHHMM(s.t);
        if (now.getHours()===hh && now.getMinutes()===mm && now.getSeconds()===0){
          const key = `${todayKey(now)} ${pad(hh)}:${pad(mm)}`;
          if (key !== lastRungKey){
            lastRungKey = key;
            ringBellPattern();
            notify('打鐘', s.label ? `${s.t}｜${s.label}` : s.t);
          }
        }
      }
    }

    // ========= 初始化 =========
    function tick(){
      const now = new Date();
      $('clock').textContent = fmt(now);
      updateNext();
      maybeRing();
    }

    function init(){
      $('tz').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone + '｜' + new Date().toLocaleString();
      renderToday();
      renderEditor();
      setInterval(tick, 1000);

      $('enable').addEventListener('click', ()=>{ ensureAudio(); audioCtx.resume?.(); ringBellPattern(); });
      $('test').addEventListener('click', ()=>{ ringBellPattern(); });
      $('notify').addEventListener('click', async ()=>{
        try{
          if (Notification.permission === 'default') await Notification.requestPermission();
          if (Notification.permission === 'granted') new Notification('通知已啟用', { body:'時間到會顯示提醒。' });
        }catch(e){ alert('此瀏覽器可能不支援通知。'); }
      });

      $('save').addEventListener('click', ()=>{
        try{
          const obj = JSON.parse($('scheduleEditor').value);
          saveSchedule(obj);
          renderToday();
          updateNext();
          alert('已儲存設定');
        }catch(e){ alert('JSON 格式錯誤：' + e.message); }
      });

      $('reset').addEventListener('click', ()=>{
        saveSchedule(DEFAULT_SCHEDULE);
        renderEditor();
        renderToday();
        updateNext();
      });
    }

    document.addEventListener('visibilitychange', ()=>{
      // 返回頁面時立即更新一次，避免倒數落後
      if (!document.hidden) tick();
    });

    window.addEventListener('load', init);
  </script>
</body>
</html>
