<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°åŒ—å¸‚åœ‹å°æ‰“é˜å™¨ï½œSchool Bell</title>
  <meta name="description" content="ä¸€å€‹å¯éƒ¨ç½²åœ¨ GitHub Pages çš„å­¸æ ¡æ‰“é˜ç¶²é ï¼Œæ™‚é–“åˆ°è‡ªå‹•éŸ¿éˆ´ä¸¦é¡¯ç¤ºå€’æ•¸èˆ‡ä¸‹ä¸€æ¬¡æ‰“é˜ã€‚" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #7e8aa0;
      --text: #e8eefc;
      --accent: #79ffe1;
      --accent-2: #4cc9f0;
      --danger: #ff6b6b;
      --ok: #00d09c;
      --ring: #ffd166;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      font-synthesis-weight: none;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    html,body{height:100%;}
    body{
      margin:0; padding:24px; background: radial-gradient(1200px 600px at 20% -10%, #15213a, var(--bg));
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', Helvetica, Arial, 'Apple Color Emoji','Segoe UI Emoji';
      display:grid; place-items: center;
    }
    .app{width:min(980px, 100%); display:grid; gap:18px;}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px; box-shadow: var(--shadow)}
    h1{margin:0 0 6px; font-weight:800; letter-spacing:.3px}
    h2{margin:0 0 10px; font-size:18px; color:var(--accent)}
    .clock{font-variant-numeric: tabular-nums; font-size:52px; font-weight:800; letter-spacing:1px}
    .sub{color:var(--muted); font-size:14px}
    .row{display:flex; gap:10px; align-items:center}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:#1a2540; color:var(--text); border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(180deg, #1f2f54, #1a2540); border-color:#2e3a5a}
    .pill{display:inline-flex; align-items:center; gap:8px; background:#17223b; border:1px solid rgba(255,255,255,.08); color:var(--muted); padding:8px 12px; border-radius:999px}
    .ok{color:var(--ok)} .danger{color:var(--danger)} .ring{color:var(--ring)}
    .list{display:grid; gap:8px; margin-top:8px}
    .item{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:12px; background:#121a2b; border:1px solid rgba(255,255,255,.06)}
    .item .time{font-weight:800; letter-spacing:.5px}
    .item .label{color:var(--muted); font-size:12px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; background:#0d1424; border:1px solid rgba(255,255,255,.1); padding:2px 6px; border-radius:6px}
    textarea{width:100%; min-height:220px; resize:vertical; border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,.12); background:#0d1424; color:var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .footer{color:var(--muted); font-size:12px; text-align:center; margin-top:8px}
    .countdown{font-variant-numeric: tabular-nums; font-size:28px; font-weight:800}
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <div class="row" style="justify-content: space-between; align-items: flex-end;">
        <div>
          <h1>å­¸æ ¡æ‰“é˜å™¨ <span class="pill"><span id="tz"></span></span></h1>
          <div class="sub">éƒ¨ç½²åœ¨ GitHub Pages çš„ç´”å‰ç«¯æ‰“é˜å·¥å…·ã€‚è«‹å…ˆé»ã€Œå•Ÿç”¨éˆ´è²ã€ä»¥ç¹éç€è¦½å™¨çš„è‡ªå‹•æ’­æ”¾é™åˆ¶ã€‚</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn primary" id="enable">ğŸ”” å•Ÿç”¨éˆ´è²</button>
          <button class="btn" id="test">è©¦è½</button>
          <button class="btn" id="notify">å…è¨±é€šçŸ¥</button>
        </div>
      </div>
      <div class="row" style="justify-content: space-between; margin-top:10px">
        <div class="clock" id="clock">--:--:--</div>
        <div style="text-align:right">
          <div class="sub">ä¸‹ä¸€æ¬¡æ‰“é˜</div>
          <div id="nextTime" class="countdown">--:--ï¼ˆ--:--ï¼‰</div>
          <div id="nextLabel" class="sub"></div>
        </div>
      </div>
    </section>

    <section class="grid">
      <section class="card">
        <h2>ä»Šå¤©æ™‚æ®µ</h2>
        <div id="todayList" class="list"></div>
      </section>

      <section class="card">
        <h2>è¨­å®š</h2>
        <div class="sub" style="margin-bottom:8px">ç·¨è¼¯ä¸‹æ–¹ JSONï¼ˆä»¥ 24 å°æ™‚åˆ¶ HH:MMï¼Œæ”¯æ´å¯é¸ labelï¼‰ã€‚æ”¯æ´ä¾æ˜ŸæœŸè¨­å®šï¼š0=é€±æ—¥â€¦6=é€±å…­ã€‚</div>
        <textarea id="scheduleEditor" spellcheck="false"></textarea>
        <div class="row" style="justify-content:flex-end; margin-top:8px">
          <button class="btn" id="reset">é‚„åŸé è¨­</button>
          <button class="btn primary" id="save">å„²å­˜è¨­å®š</button>
        </div>
      </section>
    </section>

    <section class="card">
      <h2>ä½¿ç”¨èªªæ˜</h2>
      <ol>
        <li>é»æ“Š <span class="kbd">ğŸ”” å•Ÿç”¨éˆ´è²</span> ä»¥å•Ÿç”¨éŸ³è¨Šæ’­æ”¾æ¬Šé™ã€‚</li>
        <li>å¦‚éœ€æ¡Œé¢æé†’ï¼Œé»æ“Š <span class="kbd">å…è¨±é€šçŸ¥</span> ä¸¦åœ¨ç€è¦½å™¨å…è¨±é€šçŸ¥æ¬Šé™ã€‚</li>
        <li>ä¿æŒé é¢é–‹å•Ÿå³å¯è‡ªå‹•æ‰“é˜ã€‚</li>
      </ol>
      <div class="footer">Made for Taipei time; auto-detects your local timezone.</div>
    </section>
  </main>

  <script>
    // ========= é è¨­æ™‚ç¨‹ï¼ˆå¯ä¾å¯¦éš›å­¸æ ¡èª¿æ•´ï¼‰ =========
    const DEFAULT_SCHEDULE = {
      // é€±ä¸€è‡³é€±äº”
      1: [
        { t: "08:00", label: "æ™¨å…‰/å°å¸«æ™‚é–“" },
        { t: "08:30", label: "ç¬¬1ç¯€" },
        { t: "09:20", label: "ä¸‹èª²" },
        { t: "09:30", label: "ç¬¬2ç¯€" },
        { t: "10:10", label: "ä¸‹èª²" },
        { t: "10:20", label: "ç¬¬3ç¯€" },
        { t: "11:00", label: "ä¸‹èª²" },
        { t: "11:10", label: "ç¬¬4ç¯€" },
        { t: "11:50", label: "åˆé¤" },
        { t: "12:40", label: "åˆä¼‘" },
        { t: "13:15", label: "ç¬¬5ç¯€" },
        { t: "13:55", label: "ä¸‹èª²" },
        { t: "14:00", label: "ç¬¬6ç¯€" },
        { t: "14:40", label: "ä¸‹èª²" },
        { t: "14:50", label: "ç¬¬7/8ç¯€" },
        { t: "15:30", label: "æ‰“æƒ" },
        { t: "16:00", label: "æ”¾å­¸" }
      ],
      2: null, 3: null, 4: null, 5: null,
      // é€±å…­é€±æ—¥é€šå¸¸ä¸ä¸Šèª²
      0: [], 6: []
    };
    // å°‡é€±äºŒè‡³é€±äº”è¤‡è£½é€±ä¸€ï¼ˆè‹¥ç‚º nullï¼‰
    for (const d of [2,3,4,5]) if (!DEFAULT_SCHEDULE[d]) DEFAULT_SCHEDULE[d] = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE[1]));

    // ========= ç‹€æ…‹ =========
    let audioCtx = null;
    let lastRungKey = null; // e.g., "2025-08-27 08:30"

    // ========= å·¥å…· =========
    const $ = (id) => document.getElementById(id);
    const pad = (n) => n.toString().padStart(2,'0');
    const fmt = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    const todayKey = (d=new Date()) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    function parseHHMM(hhmm){
      const [hh, mm] = hhmm.split(":").map(Number); return {hh, mm};
    }

    function loadSchedule(){
      const raw = localStorage.getItem('bell.schedule');
      if (raw){
        try{ return JSON.parse(raw); }catch(e){ console.warn('Invalid saved schedule, fallback to default'); }
      }
      return DEFAULT_SCHEDULE;
    }

    function saveSchedule(obj){
      localStorage.setItem('bell.schedule', JSON.stringify(obj, null, 2));
    }

    function getTodaySlots(){
      const now = new Date();
      const dow = now.getDay(); // 0 Sun .. 6 Sat
      const schedule = loadSchedule();
      return schedule[dow] || [];
    }

    function nextBell(from = new Date()){
      const now = from;
      const schedule = loadSchedule();
      for (let add=0; add<=7; add++){
        const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()+add, 0, 0, 0, 0);
        const dow = d.getDay();
        const slots = schedule[dow] || [];
        for (const s of slots){
          const {hh, mm} = parseHHMM(s.t);
          const when = new Date(d.getFullYear(), d.getMonth(), d.getDate(), hh, mm, 0, 0);
          const key = `${when.toISOString().slice(0,10)} ${pad(hh)}:${pad(mm)}`;
          if (when > now && key !== lastRungKey){
            return { when, label: s.label || '', key };
          }
        }
      }
      return null;
    }

    function renderToday(){
      const list = $('todayList');
      const slots = getTodaySlots();
      if (!slots.length){ list.innerHTML = '<div class="sub">ä»Šæ—¥ç„¡æ‰“é˜ã€‚</div>'; return; }
      list.innerHTML = slots.map(s => `
        <div class="item">
          <div class="time">${s.t}</div>
          <div class="label">${s.label || ''}</div>
        </div>
      `).join('');
    }

    function renderEditor(){
      const ed = $('scheduleEditor');
      const obj = loadSchedule();
      ed.value = JSON.stringify(obj, null, 2);
    }

    function updateNext(){
      const n = nextBell();
      const el = $('nextTime');
      const lbl = $('nextLabel');
      if (!n){ el.textContent = 'â€”'; lbl.textContent=''; return; }
      const now = new Date();
      const secs = Math.max(0, Math.floor((n.when - now)/1000));
      const hh = Math.floor(secs/3600), mm = Math.floor((secs%3600)/60), ss = secs%60;
      el.textContent = `${pad(n.when.getHours())}:${pad(n.when.getMinutes())}ï¼ˆ${pad(hh)}:${pad(mm)}:${pad(ss)}ï¼‰`;
      lbl.textContent = n.label || '';
    }

    // ========= éˆ´è²ï¼ˆç„¡éœ€éŸ³æª”ï¼ŒWebAudio ç”¢ç”Ÿï¼‰ =========
    function ensureAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

    function ringBellPattern(){
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      // ä¸‰è²æç¤ºï¼šé«˜-ä½-é«˜ï¼Œé¡é˜è²
      const pattern = [
        { f: 1100, dur: 0.25 },
        { gap: 0.08 },
        { f: 800, dur: 0.25 },
        { gap: 0.08 },
        { f: 1100, dur: 0.35 },
      ];
      let t = now;
      for (const p of pattern){
        if (p.gap){ t += p.gap; continue; }
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = p.f;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.7, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + p.dur);
        o.connect(g).connect(ctx.destination);
        o.start(t); o.stop(t + p.dur + 0.02);
        t += p.dur;
      }
    }

    async function notify(title, body){
      try{
        if (Notification.permission === 'granted'){
          new Notification(title, { body });
        }
      }catch(e){ /* ignore */ }
    }

    function maybeRing(){
      const sched = loadSchedule();
      const now = new Date();
      const dow = now.getDay();
      const slots = sched[dow] || [];
      for (const s of slots){
        const {hh, mm} = parseHHMM(s.t);
        if (now.getHours()===hh && now.getMinutes()===mm && now.getSeconds()===0){
          const key = `${todayKey(now)} ${pad(hh)}:${pad(mm)}`;
          if (key !== lastRungKey){
            lastRungKey = key;
            ringBellPattern();
            notify('æ‰“é˜', s.label ? `${s.t}ï½œ${s.label}` : s.t);
          }
        }
      }
    }

    // ========= åˆå§‹åŒ– =========
    function tick(){
      const now = new Date();
      $('clock').textContent = fmt(now);
      updateNext();
      maybeRing();
    }

    function init(){
      $('tz').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone + 'ï½œ' + new Date().toLocaleString();
      renderToday();
      renderEditor();
      setInterval(tick, 1000);

      $('enable').addEventListener('click', ()=>{ ensureAudio(); audioCtx.resume?.(); ringBellPattern(); });
      $('test').addEventListener('click', ()=>{ ringBellPattern(); });
      $('notify').addEventListener('click', async ()=>{
        try{
          if (Notification.permission === 'default') await Notification.requestPermission();
          if (Notification.permission === 'granted') new Notification('é€šçŸ¥å·²å•Ÿç”¨', { body:'æ™‚é–“åˆ°æœƒé¡¯ç¤ºæé†’ã€‚' });
        }catch(e){ alert('æ­¤ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´é€šçŸ¥ã€‚'); }
      });

      $('save').addEventListener('click', ()=>{
        try{
          const obj = JSON.parse($('scheduleEditor').value);
          saveSchedule(obj);
          renderToday();
          updateNext();
          alert('å·²å„²å­˜è¨­å®š');
        }catch(e){ alert('JSON æ ¼å¼éŒ¯èª¤ï¼š' + e.message); }
      });

      $('reset').addEventListener('click', ()=>{
        saveSchedule(DEFAULT_SCHEDULE);
        renderEditor();
        renderToday();
        updateNext();
      });
    }

    document.addEventListener('visibilitychange', ()=>{
      // è¿”å›é é¢æ™‚ç«‹å³æ›´æ–°ä¸€æ¬¡ï¼Œé¿å…å€’æ•¸è½å¾Œ
      if (!document.hidden) tick();
    });

    window.addEventListener('load', init);
  </script>
</body>
</html>
